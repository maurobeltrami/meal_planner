{% load static %}

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpesaFacile | {{ title }}</title>
    <link rel="stylesheet" href="{% static 'core/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        .add-ingredient-btn {
            background-color: #28a745; /* Verde per aggiungere */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            text-align: center;
        }
        .ingredient-form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }
        .ingredient-form-row select, .ingredient-form-row input[type="number"], .ingredient-form-row input[type="text"] {
            flex-grow: 1;
        }
        .ingredient-form-row input[type="checkbox"] {
            margin-left: 10px;
        }
        #empty-form-template {
            display: none; /* Nasconde il modello */
        }
        .submit-btn.delete-btn {
            background-color: #dc3545;
        }
        .submit-btn.style-ingredient-add {
            background-color: #007bff;
        }
    </style>
</head>
<body>
    
    <a href="{% url 'weekly_plan' %}" class="back-link">
        <i class="fas fa-arrow-left"></i> Torna al Piano Settimanale
    </a>

    <h1>{{ title }}</h1>

    <div class="form-section">
        <h3>Dettagli Base</h3>
        
        <form method="post" action="
            {% if is_new %}
                {% url 'recipe_create' %}
            {% else %}
                {% url 'recipe_detail' pk=recipe.pk %} 
            {% endif %}
        ">
        {% csrf_token %}
        
        {{ form.as_p }}
        
        <h3 style="margin-top: 30px;">Ingredienti e Quantità</h3>
        
        <div id="ingredient-form-container">
            {{ formset.management_form }}
            
            {% for form_ri in formset %}
                <div class="ingredient-form-row">
                    {% for field in form_ri.hidden_fields %}
                        {{ field }}
                    {% endfor %}
                    
                    {{ form_ri.ingredient }}
                    {{ form_ri.quantity }}
                    
                    <label for="{{ form_ri.DELETE.id_for_label }}" style="white-space: nowrap;">Cancella</label>
                    {{ form_ri.DELETE }}
                </div>
            {% endfor %}
            
        </div>
        
        <button type="button" id="add-ingredient-btn" class="add-ingredient-btn">
            <i class="fas fa-plus"></i> Aggiungi Ingrediente
        </button>

        <button type="submit" class="submit-btn full-width-btn" style="margin-top: 20px;">Salva Ricetta</button>
        
        </form>
    </div>

    <div id="empty-form-template">
        {% if formset|length > 0 %}
            <div class="ingredient-form-row" id="empty-form">
                {% with form_ri=formset.empty_form %}
                    {% for field in form_ri.hidden_fields %}
                        {{ field }}
                    {% endfor %}
                    {{ form_ri.ingredient }}
                    {{ form_ri.quantity }}
                    <label for="{{ form_ri.DELETE.id_for_label }}" style="white-space: nowrap;">Cancella</label>
                    {{ form_ri.DELETE }}
                {% endwith %}
            </div>
        {% else %}
            <div class="ingredient-form-row" id="empty-form">
                <input type="hidden" name="form-ID-id" id="id_form-ID-id">
                <select name="form-ID-ingredient" id="id_form-ID-ingredient"></select>
                <input type="number" name="form-ID-quantity" id="id_form-ID-quantity">
                <input type="hidden" name="form-ID-DELETE" id="id_form-ID-DELETE">
                <label for="id_form-ID-DELETE" style="white-space: nowrap;">Cancella</label>
                <input type="checkbox" name="form-ID-DELETE" id="id_form-ID-DELETE">
            </div>
        {% endif %}
    </div>


    {% if ingredient_form %}
        <div class="form-section ingredient-quick-add">
            <h3>➕ Aggiungi Ingrediente Mancante</h3>
            <p class="small-info">Se l'ingrediente che cerchi non è nella lista, aggiungilo qui. Dovrai salvare nuovamente la ricetta in corso.</p>
            
            <form method="post" action="{% url 'ingredient_create' %}">
                {% csrf_token %}
                
                <input type="hidden" name="next_url" value="{% if is_new %}recipe_create{% else %}recipe_detail{% endif %}">
                {% if not is_new and recipe %}
                    <input type="hidden" name="recipe_pk" value="{{ recipe.pk }}">
                {% endif %}

                {{ ingredient_form.as_p }}
                
                <button type="submit" class="submit-btn full-width-btn style-ingredient-add">
                    <i class="fas fa-carrot"></i> Salva e Ricarica Ricetta
                </button>
            </form>
        </div>
    {% endif %}

    {% if not is_new and recipe %}
        <div class="form-section delete-section">
            <h3>Gestione Avanzata</h3>
            
            <form method="post" action="{% url 'recipe_delete' pk=recipe.pk %}" onsubmit="return confirm('Sei sicuro di voler eliminare definitivamente questa ricetta?');">
                {% csrf_token %}
                <button type="submit" class="submit-btn full-width-btn delete-btn">
                    <i class="fas fa-trash-alt"></i> Elimina Ricetta
                </button>
            </form>
        </div>
    {% endif %}
    
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var addButton = document.getElementById('add-ingredient-btn');
            var container = document.getElementById('ingredient-form-container');
            var template = document.getElementById('empty-form-template');
            
            // Trova gli elementi del formset management
            var totalForms = document.querySelector('input[name="{{ formset.management_form.TOTAL_FORMS.html_name }}"]');
            
            // Assicurati che il template esista e contenga la riga vuota
            var emptyRowModel = template.querySelector('.ingredient-form-row');
            if (!emptyRowModel) {
                 console.error("Modello di riga vuota non trovato. Controlla #empty-form-template.");
                 return;
            }

            // Ottieni l'HTML del modello (come stringa)
            var emptyHtml = emptyRowModel.innerHTML;


            addButton.addEventListener('click', function() {
                // 1. Ottieni l'indice del nuovo form
                var currentTotal = parseInt(totalForms.value);
                
                // 2. Sostituisci l'indice nel codice HTML
                var newFormHtml = emptyHtml.replace(/__prefix__/g, currentTotal)
                                           .replace(/-ID-/g, '-' + currentTotal + '-'); // Sostituzione specifica
                
                // 3. Crea il nuovo elemento div
                var newForm = document.createElement('div');
                newForm.className = 'ingredient-form-row';
                newForm.innerHTML = newFormHtml;
                
                // 4. Pulisci i valori e aggiungi
                newForm.querySelectorAll('input, select').forEach(function(input) {
                    // Solo per i campi di input non nascosti (quantity)
                    if (input.type !== 'hidden' && input.type !== 'checkbox') {
                        input.value = ''; 
                    }
                    if (input.type === 'checkbox') {
                         input.checked = false;
                    }
                });

                // 5. Aggiungi il nuovo form al container
                container.appendChild(newForm);
                
                // 6. Aggiorna TOTAL_FORMS
                totalForms.value = currentTotal + 1;
            });
        });
    </script>
    
</body>
</html>