{% load static %}
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{% static 'core/style.css' %}">
    <style>
        /* CSS Aggiuntivo per il pulsante */
        #add-more-btn {
            background-color: #f39c12;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <a href="{% url 'weekly_plan' %}" class="back-link">‚¨ÖÔ∏è Torna al Piano Settimanale</a>
    <h1>üçΩÔ∏è {{ title }}</h1>
    
    <div class="formset-container">
        <form method="post" id="recipe-form">
            {% csrf_token %}
            
            <div class="recipe-name-form form-section" style="margin-bottom: 20px;">
                <h3>Dettagli Base</h3>
                {{ recipe_form.as_p }}
            </div>

            <div class="ingredients-formset-section form-section">
                <h3>Ingredienti e Quantit√†</h3>
                
                {{ formset.management_form }}
                
                <div id="formset-body">
                    {% for form in formset %}
                        <div class="formset-row" data-formset-row>
                            {{ form.id }}
                            {{ form.recipe }} 
                            
                            <div class="field-label">{{ form.ingredient.label_tag }}</div>
                            <div class="field-input">{{ form.ingredient }}</div>
                            
                            <div class="field-label">{{ form.quantity.label_tag }}</div>
                            <div class="field-input">{{ form.quantity }}</div>
                            
                            <div class="delete-checkbox">
                                {{ form.DELETE.label_tag }}
                                {{ form.DELETE }}
                            </div>
                            
                            {% if form.errors %}
                                <div style="color: red;">
                                    {% for field in form %}{% for error in field.errors %}
                                        <p>{{ field.label }}: {{ error }}</p>
                                    {% endfor %}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                
                <button type="button" id="add-more-btn">‚ûï Aggiungi altro ingrediente</button>

            </div>
            
            <button type="submit" class="submit-btn" style="width: 100%; margin-top: 30px;">Salva Ricetta Completa</button>
        </form>
    </div>

    <div class="form-section" style="margin-top: 20px;">
        <h3>üå± Oppure, Crea Nuovo Ingrediente al volo</h3>
        
        {% if is_new %}
            <form method="post" action="{% url 'recipe_create' %}" style="display:inline;">
        {% else %}
            <form method="post" action="{% url 'recipe_update' pk=recipe_form.instance.pk %}" style="display:inline;">
        {% endif %}
        
            {% csrf_token %}
            <input type="hidden" name="action" value="add_ingredient">
            {{ ingredient_form.as_p }}
            <button type="submit" style="width: auto;">Crea Ingrediente</button>
        </form>
        <p style="margin-top: 10px; font-size: 0.8em;">Dopo aver creato il nuovo ingrediente, ricarica la pagina per vederlo nel menu a tendina.</p>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addButton = document.getElementById('add-more-btn');
            const formsetBody = document.getElementById('formset-body');
            const totalFormsInput = document.querySelector('input[name$="TOTAL_FORMS"]');
            
            // Troviamo l'ultima riga esistente per usarla come modello di clonazione
            const lastRow = formsetBody.querySelector('[data-formset-row]:last-child');
            if (!lastRow) {
                console.error("Non √® stato trovato un formset-row da clonare. Verifica che formset.management_form sia presente.");
                return;
            }

            // Funzione helper per ottenere l'indice massimo corrente (per clonare l'ultima riga)
            function getLastIndex() {
                let maxIndex = -1;
                formsetBody.querySelectorAll('[data-formset-row]').forEach(row => {
                    // Cerca il nome di un campo per estrarre l'indice
                    const inputName = row.querySelector('input, select, textarea')?.name;
                    if (inputName) {
                        const match = inputName.match(/(\d+)/);
                        if (match) {
                            maxIndex = Math.max(maxIndex, parseInt(match[1]));
                        }
                    }
                });
                return maxIndex;
            }
            
            addButton.addEventListener('click', function() {
                // 1. Clonare l'ultima riga esistente
                const newForm = lastRow.cloneNode(true); 

                // 2. Ottenere il nuovo indice (basato su TOTAL_FORMS, che √® l'indice corretto per la creazione)
                let currentForms = parseInt(totalFormsInput.value);
                const newIndex = currentForms;

                // 3. Regex per sostituire l'indice precedente con il nuovo indice
                // Non possiamo usare l'indice precedente, usiamo la regex dinamica sul DOM clonato
                const regex = new RegExp(`-[0-9]+-`, 'g');
                
                // 4. Sostituzione di tutti gli attributi (name, id, for) con il nuovo indice
                newForm.innerHTML = newForm.innerHTML.replace(regex, `-${newIndex}-`);

                // 5. Ripulire i campi della nuova riga clonata
                newForm.querySelectorAll('input, select, textarea').forEach(element => {
                    // Imposta i campi a vuoto
                    if (element.type !== 'hidden' && element.type !== 'checkbox') {
                        element.value = '';
                    }
                    // Assicura che la checkbox DELETE sia deselezionata
                    if (element.type === 'checkbox' && element.name.endsWith('-DELETE')) {
                        element.checked = false;
                    }
                });

                // 6. Aggiungere la nuova riga al DOM
                formsetBody.appendChild(newForm);
                
                // 7. Aggiornare il contatore totale nel Management Form
                totalFormsInput.value = currentForms + 1;
            });
        });
    </script>
</body>
</html>