{% load static %}
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{% static 'core/style.css' %}">
</head>
<body>
    <a href="{% url 'weekly_plan' %}" class="back-link">‚¨ÖÔ∏è Torna al Piano Settimanale</a>
    <h1>üçΩÔ∏è {{ title }}</h1>
    
    <div class="formset-container">
        
        <form method="post" id="recipe-form">
            {% csrf_token %}
            
            <div class="recipe-name-form form-section" style="margin-bottom: 25px;">
                <h3>Dettagli Base</h3>
                {{ recipe_form.as_p }}
            </div>

            <div class="ingredients-formset-section form-section">
                <h3>Ingredienti e Quantit√†</h3>
                
                {{ formset.management_form }}
                
                <div id="formset-body">
                    {% for form in formset %}
                        <div class="formset-row" data-formset-row>
                            
                            {{ form.id }}
                            {{ form.recipe }} 
                            
                            <div class="field-input">
                                <label for="{{ form.ingredient.id_for_label }}">{{ form.ingredient.label }}</label>
                                {{ form.ingredient }}
                            </div>
                            
                            <div class="field-input">
                                <label for="{{ form.quantity.id_for_label }}">{{ form.quantity.label }}</label>
                                {{ form.quantity }}
                            </div>
                            
                            <div class="delete-checkbox">
                                {{ form.DELETE.label_tag }}
                                {{ form.DELETE }}
                            </div>
                            
                            {% if form.errors %}
                                <div style="grid-column: 1 / span 3; color: red; font-size: 0.9em; margin-top: 5px;">
                                    Si prega di correggere gli errori.
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                
                <button type="button" id="add-more-btn">‚ûï Aggiungi altro ingrediente</button>

            </div>
            
            <button type="submit" class="submit-btn" style="width: 100%; margin-top: 30px;">Salva Ricetta Completa</button>
        </form>
    </div>

    <div class="form-section" style="margin-top: 20px;">
        <h3>üå± Oppure, Crea Nuovo Ingrediente al volo</h3>
        
        {% if is_new %}
            <form method="post" action="{% url 'recipe_create' %}" style="display:inline;">
        {% else %}
            <form method="post" action="{% url 'recipe_update' pk=recipe_form.instance.pk %}" style="display:inline;">
        {% endif %}
        
            {% csrf_token %}
            <input type="hidden" name="action" value="add_ingredient">
            {{ ingredient_form.as_p }}
            <button type="submit" style="width: auto;">Crea Ingrediente</button>
        </form>
        <p style="margin-top: 15px; font-size: 0.9em; color: #777;">
            Dopo aver creato il nuovo ingrediente, ricarica la pagina per vederlo nel menu a tendina e aggiungerlo alla ricetta.
        </p>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addButton = document.getElementById('add-more-btn');
            const formsetBody = document.getElementById('formset-body');
            const totalFormsInput = document.querySelector('input[name$="TOTAL_FORMS"]');
            
            // Troviamo il modello (il template da clonare). Se non ci sono righe, non facciamo nulla.
            const lastRow = formsetBody.querySelector('[data-formset-row]:last-child');
            if (!lastRow) return;

            addButton.addEventListener('click', function() {
                // 1. Clonare l'ultima riga esistente
                const newForm = lastRow.cloneNode(true); 

                // 2. Ottenere il nuovo indice
                let currentForms = parseInt(totalFormsInput.value);
                const newIndex = currentForms;

                // 3. Regex per sostituire l'indice
                // Sostituisce l'indice numerico (es: '-0-', '-1-', etc.) con il nuovo indice
                const regex = new RegExp(`-${currentForms - 1}-`, 'g'); // Clona l'indice dell'ultima riga
                
                // Sostituzione di tutti gli attributi (name, id, for) con il nuovo indice
                newForm.innerHTML = newForm.innerHTML.replace(regex, `-${newIndex}-`);

                // 4. Ripulire i campi della nuova riga clonata
                newForm.querySelectorAll('input, select, textarea').forEach(element => {
                    // Solo i campi dati devono essere vuoti o non spuntati
                    const name = element.getAttribute('name');
                    
                    if (element.type === 'text' || element.type === 'number') {
                        element.value = '';
                    } else if (element.type === 'select-one') {
                        // Resetta il select al primo valore (solitamente vuoto o placeholder)
                        element.selectedIndex = 0;
                    } else if (element.type === 'checkbox' && name && name.endsWith('-DELETE')) {
                        element.checked = false;
                    }
                    // Nasconde il campo ID (se presente) che √® gestito dal formset
                    if (name && name.endsWith('-id')) { 
                        element.value = '';
                    }
                });
                
                // 5. Aggiungere la nuova riga al DOM
                formsetBody.appendChild(newForm);
                
                // 6. Aggiornare il contatore totale nel Management Form
                totalFormsInput.value = currentForms + 1;
            });
        });
    </script>
</body>
</html>