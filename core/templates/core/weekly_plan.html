{% load custom_filters %} 
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Piano Settimanale</title>
    <style>
        /* CSS Base e Stili Form */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 40px; background-color: #f4f7f6; color: #333; }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 25px; }
        .recipe-link { color: #2980b9; text-decoration: none; font-weight: 600; }
        .recipe-link:hover { text-decoration: underline; }
        
        .forms-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .form-section { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #ddd; }
        .form-section h3 { margin-top: 0; color: #3498db; }
        .form-section label { display: block; margin-top: 10px; font-weight: 600; }
        .form-section select, .form-section input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        .form-section button { width: 100%; background-color: #27ae60; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .form-section button:hover { background-color: #2ecc71; }

        /* Stile Griglia (risolto il disallineamento) */
        .grid-container { 
            display: grid; 
            grid-template-columns: 1fr repeat({{ meal_types|length }}, 1fr); 
            border: 1px solid #ccc; 
            background-color: #fff; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            border-radius: 8px;
            overflow: hidden;
        }
        .header { background-color: #3498db; color: white; font-weight: bold; text-align: center; padding: 12px 10px; font-size: 0.95em; }
        .cell { padding: 15px; border-bottom: 1px solid #ecf0f1; border-right: 1px solid #ecf0f1; min-height: 50px; display: flex; align-items: center; }
        .day-cell { background-color: #ecf0f1; font-weight: bold; color: #2c3e50; border-right: 2px solid #ccc; }
        .meal-cell { font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>üóìÔ∏è Il Tuo Piano Settimanale</h1>
    <p>
        <a href="{% url 'shopping_list' %}" class="recipe-link" style="font-size: 1.1em;">
            ‚û°Ô∏è Genera e Visualizza la Lista della Spesa
        </a>
    </p>

    <div class="forms-container">
        <div class="form-section">
            <h3>‚ûï Crea Nuova Ricetta (Nome)</h3>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_recipe">
                {{ recipe_form.as_p }}
                <button type="submit">Crea Ricetta</button>
            </form>
        </div>

        <div class="form-section">
            <h3>üå± Crea Nuovo Ingrediente (e Unit√†)</h3>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_ingredient">
                {{ ingredient_form.as_p }}
                <button type="submit">Crea Ingrediente</button>
            </form>
        </div>
    </div>
    
    <div class="form-section" style="grid-column: 1 / 3;">
        <h3>‚úèÔ∏è Aggiungi o Modifica Pasto</h3>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_plan">
            {{ form.as_p }}
            <button type="submit">Salva Pasto</button>
        </form>
    </div>

    <div class="grid-container">
        <div class="header">Giorno</div>
        {% for meal_code, meal_name in meal_types %}
            <div class="header">{{ meal_name }}</div>
        {% endfor %}

        {% for day_code, day_data in meal_grid.items %}
            <div class="cell day-cell">{{ day_data.name }}</div>
            
            {% for meal_code, meal_name in meal_types %}
                <div class="cell meal-cell">
                    {% with meal_data=day_data.meals|get_item:meal_code %}
                        {% if meal_data %}
                            <a href="{% url 'recipe_detail' pk=meal_data.pk %}" class="recipe-link">
                                {{ meal_data.name }}
                            </a>
                        {% else %}
                            - (Vuoto) -
                        {% endif %}
                    {% endwith %}
                </div>
            {% endfor %}
        {% endfor %}
    </div>
</body>
</html>